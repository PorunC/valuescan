# Chrome 自动重启功能说明

## 功能介绍

为了解决 Chrome Debug 模式长时间运行导致的内存泄漏和卡顿问题，我们添加了自动重启功能。

## 工作原理

程序会在后台计时，当运行时间达到配置的时长后，会自动：
1. 停止当前的 API 监听
2. 关闭 Chrome 浏览器
3. 重新启动 Chrome（清理内存）
4. 恢复 API 监听

整个过程自动完成，无需手动干预。

## 配置方法

### 在 `config.py` 中设置：

```python
# Chrome 自动重启间隔（小时）
# 设置为 0 表示不自动重启
# 建议值：2-4 小时，可以有效防止内存泄漏导致的卡顿
CHROME_AUTO_RESTART_HOURS = 3
```

### 推荐配置：

| 使用场景 | 推荐间隔 | 说明 |
|---------|---------|------|
| 短期监控 | 0 小时 | 禁用自动重启，手动管理 |
| 日常使用 | 3-4 小时 | 平衡性能和稳定性 |
| 长期运行 | 2 小时 | 频繁重启，保持最佳性能 |
| 低配置电脑 | 1-2 小时 | 更频繁重启，避免卡顿 |

## 使用方法

### 方法 1：正常启动（推荐）

```bash
python start_with_chrome.py
```

或双击 `启动.bat`

程序会自动按照配置的间隔重启。

### 方法 2：禁用自动重启

如果不想使用自动重启功能，有两种方法：

**方法 A：修改配置**
```python
CHROME_AUTO_RESTART_HOURS = 0
```

**方法 B：手动停止**
- 按 `Ctrl+C` 可以随时停止程序
- 程序不会自动重启

## 运行日志示例

### 启用自动重启时：
```
🚀 ValueScan 一键启动
============================================================
⏰ 已启用自动重启功能（每 3 小时）
============================================================
开始监听 API 请求...
⏰ 自动重启: 每 3 小时
...
============================================================
⏰ 已运行 3.0 小时，触发自动重启
📊 本次运行统计: 捕获 156 个请求
============================================================
🔄 第 2 次自动重启
...
```

### 禁用自动重启时：
```
🚀 ValueScan 一键启动
============================================================
ℹ️ 自动重启功能已禁用
============================================================
开始监听 API 请求...
```

## 注意事项

1. **数据保护**
   - 重启时会保留已记录的消息 ID
   - Telegram 消息记录不会丢失
   - Chrome 登录状态会保留

2. **重启过程**
   - 重启过程约需 5-10 秒
   - 重启期间会错过的 API 请求
   - 建议设置合理的重启间隔

3. **手动停止**
   - 随时按 `Ctrl+C` 可以停止程序
   - 不会触发自动重启
   - 安全退出

4. **内存优化**
   - 自动重启会清理 Chrome 内存
   - 不会删除 Chrome 用户数据
   - 登录状态和 Cookie 都会保留

## 性能对比

### 不使用自动重启：
- 运行 8 小时：内存占用 2-4 GB，可能出现卡顿
- 运行 12 小时：内存占用 4-6 GB，明显卡顿
- 运行 24 小时：可能导致系统响应缓慢

### 使用自动重启（3 小时）：
- 始终保持：内存占用 500 MB - 1.5 GB
- 运行流畅，无卡顿
- 长期稳定运行

## 故障排查

### Q: 重启后无法连接到 Chrome？
A: 检查端口 9222 是否被占用，可能需要手动重启程序

### Q: 重启过程太频繁？
A: 增加 `CHROME_AUTO_RESTART_HOURS` 的值，比如改为 4 或 6

### Q: 想要手动控制重启？
A: 设置 `CHROME_AUTO_RESTART_HOURS = 0`，然后手动按 Ctrl+C 重启

### Q: 重启时丢失了 Chrome 登录？
A: 不会丢失，所有数据保存在 `chrome-debug-profile` 目录

## 高级技巧

### 1. 查看运行时长
程序停止时会显示：
```
监听已停止 (运行时长: 3.2 小时, 捕获 185 个请求)
```

### 2. 避免重启期间的消息丢失
- 设置合理的重启间隔（避免高峰期）
- 或者禁用自动重启，手动选择空闲时段重启

### 3. 监控内存使用
使用任务管理器查看 `chrome.exe` 的内存占用：
- 正常：< 1.5 GB
- 警告：1.5 - 3 GB（考虑重启）
- 危险：> 3 GB（建议立即重启或减少重启间隔）

## 推荐设置

```python
# config.py 推荐配置

# 一般用户（8-16 GB 内存）
CHROME_AUTO_RESTART_HOURS = 3

# 大内存用户（32 GB+）
CHROME_AUTO_RESTART_HOURS = 4

# 低配置用户（4-8 GB 内存）
CHROME_AUTO_RESTART_HOURS = 2

# 测试或短期使用
CHROME_AUTO_RESTART_HOURS = 0
```

---

**建议：** 首次使用时设置为 3 小时，观察一段时间后根据实际情况调整。
